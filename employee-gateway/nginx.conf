worker_processes auto;
error_log /usr/local/openresty/nginx/logs/error.log warn;
pid /usr/local/openresty/nginx/logs/nginx.pid;

# Pass environment variables to Lua
env ENTRA_TENANT_ID;
env ENTRA_CLIENT_ID;
env ENTRA_CLIENT_SECRET;
env ENTRA_REDIRECT_URI;
env REDIS_HOST;
env REDIS_PORT;
env SESSION_TTL_SECONDS;
env SESSION_COOKIE_NAME;
env BACKEND_URL;

events {
    worker_connections 1024;
}

http {
    include       /usr/local/openresty/nginx/conf/mime.types;
    default_type  application/octet-stream;

    # SSL certificates for outgoing HTTPS requests (to Microsoft Entra)
    lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
    lua_ssl_verify_depth 3;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /usr/local/openresty/nginx/logs/access.log main;

    sendfile        on;
    keepalive_timeout  65;

    # Lua package path
    lua_package_path "/usr/local/openresty/nginx/lua/?.lua;;";

    # Shared memory for session caching and configuration
    lua_shared_dict sessions 10m;
    lua_shared_dict config 1m;

    # Initialize configuration at startup
    init_by_lua_block {
        local config = ngx.shared.config

        -- Load environment variables into shared memory
        config:set("entra_tenant_id", os.getenv("ENTRA_TENANT_ID") or "")
        config:set("entra_client_id", os.getenv("ENTRA_CLIENT_ID") or "")
        config:set("entra_client_secret", os.getenv("ENTRA_CLIENT_SECRET") or "")
        config:set("entra_redirect_uri", os.getenv("ENTRA_REDIRECT_URI") or "http://localhost/oauth2/callback")
        config:set("redis_host", os.getenv("REDIS_HOST") or "redis")
        config:set("redis_port", tonumber(os.getenv("REDIS_PORT")) or 6379)
        config:set("session_ttl", tonumber(os.getenv("SESSION_TTL_SECONDS")) or 1200)
        config:set("session_cookie_name", os.getenv("SESSION_COOKIE_NAME") or "ENTRA_SESSION")
        config:set("backend_url", os.getenv("BACKEND_URL") or "http://portal:8081")

        ngx.log(ngx.INFO, "Entra Auth Gateway initialized")
    }

    # Redis upstream for connection pooling
    upstream redis_backend {
        server redis:6379;
        keepalive 32;
    }

    include /etc/nginx/conf.d/*.conf;
}
