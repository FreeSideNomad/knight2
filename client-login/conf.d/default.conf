# Auth0 Authentication Gateway Server Configuration
server {
    listen 80;
    server_name localhost;

    # Preserve port in redirects (e.g., when running on non-standard ports like 9000)
    absolute_redirect off;

    # Resolver for dynamic DNS (Docker)
    resolver 127.0.0.11 valid=30s ipv6=off;

    # Health check endpoint (no auth required)
    location /health {
        access_log off;
        return 200 '{"status":"healthy"}';
        add_header Content-Type application/json;
    }

    # Custom login pages (no auth required)
    # Match both /login and /login/ to avoid redirect issues
    location /login/ {
        alias /usr/local/openresty/nginx/login/;
        index index.html;
        try_files $uri $uri/ /login/index.html;

        # Disable caching for JS files during development
        location ~* \.js$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
    }

    # Redirect /login to /login/ without losing port
    location = /login {
        rewrite ^ /login/ last;
    }

    # Pre-session CSRF token endpoint - generates token for login protection
    # Called by JavaScript when login page loads
    # Returns HMAC-signed token + sets key cookie (Lapis pattern)
    location /api/csrf/login-token {
        content_by_lua_block {
            -- Only allow same-origin requests
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end

            local csrf = require "csrf"
            local cjson = require "cjson"
            local token, key = csrf.generate_login_token()
            if token and key then
                -- Set the key in a cookie (HttpOnly for security)
                local cookie = "LOGIN_CSRF_KEY=" .. key .. "; Path=/; HttpOnly; SameSite=Strict; Max-Age=300"
                ngx.header["Set-Cookie"] = cookie
                ngx.header["Content-Type"] = "application/json"
                -- Return the signed token in response body
                ngx.say(cjson.encode({success = true, token = token}))
            else
                ngx.status = 500
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"server_error","error_description":"Failed to generate token"}')
            end
        }
    }

    # CORS protection helper - blocks cross-origin requests
    # Reusable access phase for all API endpoints
    set $cors_check "";

    # ============================================
    # Auth API Endpoints (no auth required - used by login page)
    # All Auth0 API calls happen server-side with secrets
    # CORS Protection: Only same-origin requests allowed
    # ============================================

    # Upstream for platform API (auth endpoints at /api/login/*)
    set $auth_service_url "http://platform:8080/api/login";

    # ============================================
    # Auth API Proxy to Java auth-service
    # CORS protection in Lua, business logic in Java
    # ============================================

    # Check if user exists and has MFA
    location /api/user/check {
        access_by_lua_block {
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            -- Set Basic Auth header for auth-service
            local config = require "config"
            ngx.req.set_header("Authorization", config.get_auth_service_basic_auth())
        }
        proxy_pass $auth_service_url/user/check;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Content-Type application/json;
    }

    # Complete onboarding for provisioned users (set password)
    location /api/user/complete-onboarding {
        access_by_lua_block {
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            -- Set Basic Auth header for auth-service
            local config = require "config"
            ngx.req.set_header("Authorization", config.get_auth_service_basic_auth())
        }
        proxy_pass $auth_service_url/user/complete-onboarding;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Content-Type application/json;
    }

    # Mark onboarding complete (set app_metadata.onboarding_complete = true)
    location /api/user/mark-onboarding-complete {
        access_by_lua_block {
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            -- Set Basic Auth header for auth-service
            local config = require "config"
            ngx.req.set_header("Authorization", config.get_auth_service_basic_auth())
        }
        proxy_pass $auth_service_url/user/mark-onboarding-complete;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Content-Type application/json;
    }

    # MFA enrollment - get available authenticators
    location /api/mfa/enrollments {
        access_by_lua_block {
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            -- Set Basic Auth header for auth-service
            local config = require "config"
            ngx.req.set_header("Authorization", config.get_auth_service_basic_auth())
        }
        proxy_pass $auth_service_url/mfa/enrollments;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Content-Type application/json;
    }

    # MFA enrollment - associate new authenticator
    location /api/mfa/associate {
        access_by_lua_block {
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            -- Set Basic Auth header for auth-service
            local config = require "config"
            ngx.req.set_header("Authorization", config.get_auth_service_basic_auth())
        }
        proxy_pass $auth_service_url/mfa/associate;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Content-Type application/json;
    }

    # MFA enrollment - verify OTP (creates session on success)
    location /api/mfa/verify {
        content_by_lua_block {
            -- CORS check
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            local api_proxy = require "api_proxy"
            api_proxy.handle_mfa_verify()
        }
    }

    # MFA Guardian - poll for enrollment approval (creates session on success)
    location /api/mfa/challenge {
        content_by_lua_block {
            -- CORS check
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            local api_proxy = require "api_proxy"
            api_proxy.handle_mfa_challenge()
        }
    }

    # Password login for returning users (creates session if no MFA required)
    location /api/auth/login {
        content_by_lua_block {
            -- CORS check
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            local api_proxy = require "api_proxy"
            api_proxy.handle_login()
        }
    }

    # Send MFA challenge (for Guardian push)
    location /api/mfa/send-challenge {
        access_by_lua_block {
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            -- Set Basic Auth header for auth-service
            local config = require "config"
            ngx.req.set_header("Authorization", config.get_auth_service_basic_auth())
        }
        proxy_pass $auth_service_url/mfa/send-challenge;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Content-Type application/json;
    }

    # Verify MFA challenge for returning users (creates session on success)
    location /api/mfa/verify-challenge {
        content_by_lua_block {
            -- CORS check
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            local api_proxy = require "api_proxy"
            api_proxy.handle_mfa_verify_challenge()
        }
    }

    # CIBA start - initiate passwordless login with Guardian push
    location /api/auth/ciba-start {
        access_by_lua_block {
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            -- Set Basic Auth header for auth-service
            local config = require "config"
            ngx.req.set_header("Authorization", config.get_auth_service_basic_auth())
        }
        proxy_pass $auth_service_url/auth/ciba-start;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Content-Type application/json;
    }

    # CIBA verify - poll for CIBA result (creates session on success)
    location /api/auth/ciba-verify {
        content_by_lua_block {
            -- CORS check
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- Login CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate_login()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "Login CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            local api_proxy = require "api_proxy"
            api_proxy.handle_ciba_verify()
        }
    }

    # ============================================
    # Session CSRF Token Endpoint (for authenticated users)
    # Returns HMAC-signed token for stepup and other protected operations
    # ============================================

    location /api/csrf/session-token {
        content_by_lua_block {
            -- Only allow same-origin requests
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end

            -- Verify user has a valid session
            local config = require "config"
            local cookie_name = config.get("session_cookie_name") or "CLIENT_SESSION"
            local cookie_header = ngx.var.http_cookie or ""
            local session_id = string.match(cookie_header, cookie_name .. "=([^;]+)")
            if not session_id or session_id == "" then
                ngx.status = 401
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"unauthorized","error_description":"No valid session"}')
                return ngx.exit(401)
            end

            local redis_client = require "redis_client"
            local session = redis_client.get_session(session_id)
            if not session then
                ngx.status = 401
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"unauthorized","error_description":"Invalid session"}')
                return ngx.exit(401)
            end

            local csrf = require "csrf"
            local cjson = require "cjson"
            local token, key = csrf.generate_session_token()
            if token and key then
                -- Set the key in a cookie (HttpOnly for security) if not already set
                local existing_key = ngx.var.cookie_SESSION_CSRF_KEY
                if not existing_key or existing_key ~= key then
                    local cookie = "SESSION_CSRF_KEY=" .. key .. "; Path=/; HttpOnly; SameSite=Strict; Max-Age=1200"
                    ngx.header["Set-Cookie"] = cookie
                end
                ngx.header["Content-Type"] = "application/json"
                -- Return the signed token in response body
                ngx.say(cjson.encode({success = true, token = token}))
            else
                ngx.status = 500
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"server_error","error_description":"Failed to generate token"}')
            end
        }
    }

    # ============================================
    # Step-Up Authentication Endpoints
    # Requires valid session - accessed from backend page
    # ============================================

    # Step-up start - initiate Guardian push for step-up authentication
    # Reads mfa_token from session and injects into request
    location /api/stepup/start {
        content_by_lua_block {
            -- CORS check
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            local api_proxy = require "api_proxy"
            api_proxy.handle_stepup_start()
        }
    }

    # Step-up verify - poll for Guardian approval
    # Reads mfa_token and oob_code from session
    location /api/stepup/verify {
        content_by_lua_block {
            -- CORS check
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            local api_proxy = require "api_proxy"
            api_proxy.handle_stepup_verify()
        }
    }

    # Step-up refresh token - re-authenticate to get fresh mfa_token
    # Updates session with new mfa_token
    location /api/stepup/refresh-token {
        content_by_lua_block {
            -- CORS check
            local origin = ngx.req.get_headers()["Origin"]
            if origin then
                local host = ngx.var.scheme .. "://" .. ngx.var.http_host
                if origin ~= host and origin ~= "http://localhost" and origin ~= "http://localhost:80" and origin ~= "http://localhost:9000" then
                    ngx.status = 403
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","error_description":"Cross-origin requests not allowed"}')
                    return ngx.exit(403)
                end
            end
            if ngx.req.get_method() == "OPTIONS" then
                ngx.status = 403
                return ngx.exit(403)
            end
            -- CSRF validation
            local csrf = require "csrf"
            local ok, err = csrf.validate()
            if not ok then
                ngx.status = 403
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"csrf_error","error_description":"' .. (err or "CSRF validation failed") .. '"}')
                return ngx.exit(403)
            end
            local api_proxy = require "api_proxy"
            api_proxy.handle_stepup_refresh_token()
        }
    }

    # ============================================
    # OAuth2 Endpoints
    # ============================================

    # OAuth2 callback endpoint
    location /oauth2/callback {
        content_by_lua_file /usr/local/openresty/nginx/lua/oauth_callback.lua;
    }

    # Login initiation endpoint (redirects to Auth0 Universal Login)
    location /oauth2/login {
        content_by_lua_file /usr/local/openresty/nginx/lua/oauth_login.lua;
    }

    # Logout endpoint
    location /logout {
        content_by_lua_file /usr/local/openresty/nginx/lua/logout.lua;
    }

    # Logout callback from Auth0
    location /logout/callback {
        content_by_lua_file /usr/local/openresty/nginx/lua/logout_callback.lua;
    }

    # ============================================
    # Protected Routes - require authentication
    # ============================================
    location / {
        # Check authentication and route to appropriate portal
        # auth.lua validates session and calls ngx.exec("@CLIENT") or ngx.exec("@INDIRECT")
        content_by_lua_file /usr/local/openresty/nginx/lua/auth.lua;
    }

    # ============================================
    # Named locations for portal routing
    # ============================================
    location @CLIENT {
        internal;

        set $client_portal_url '';
        rewrite_by_lua_block {
            ngx.var.client_portal_url = ngx.shared.sessions:get("config_client_portal_url") or "http://client-portal:8080"
        }

        proxy_pass $client_portal_url;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location @INDIRECT {
        internal;

        set $indirect_portal_url '';
        rewrite_by_lua_block {
            ngx.var.indirect_portal_url = ngx.shared.sessions:get("config_indirect_portal_url") or "http://indirect-client-portal:8080"
        }

        proxy_pass $indirect_portal_url;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Error pages
    error_page 401 /oauth2/login;
    error_page 500 502 503 504 /50x.html;

    location = /50x.html {
        root /usr/local/openresty/nginx/html;
        internal;
    }
}
