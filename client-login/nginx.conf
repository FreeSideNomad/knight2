# OpenResty (Nginx + Lua) Configuration for Client Login Gateway
worker_processes auto;
error_log /var/log/nginx/error.log info;
pid /var/run/nginx.pid;

# Environment variables to pass to Lua
env AUTH0_DOMAIN;
env AUTH0_WEB_CLIENT_ID;
env AUTH0_WEB_CLIENT_SECRET;
env AUTH0_API_AUDIENCE;
env REDIS_HOST;
env REDIS_PORT;
env CLIENT_SESSION_TTL;
env CLIENT_SESSION_COOKIE;
env PLATFORM_API_URL;
env LOGIN_API_USERNAME;
env LOGIN_API_PASSWORD;
env CLIENT_PORTAL_URL;
env INDIRECT_PORTAL_URL;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /usr/local/openresty/nginx/conf/mime.types;
    default_type application/octet-stream;

    # Logging format
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'session_id="$cookie_CLIENT_SESSION"';

    access_log /var/log/nginx/access.log main;

    # Performance settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript
               application/xml application/xml+rss text/javascript;

    # Lua settings
    lua_package_path "/usr/local/openresty/nginx/lua/?.lua;/usr/local/openresty/lualib/?.lua;;";
    lua_shared_dict sessions 10m;
    lua_shared_dict rate_limit 10m;

    # Initialize Lua modules on startup
    init_by_lua_block {
        require "resty.core"

        -- Load configuration from environment
        local config = {
            auth0_domain = os.getenv("AUTH0_DOMAIN") or "dbc-test.auth0.com",
            auth0_client_id = os.getenv("AUTH0_WEB_CLIENT_ID") or "",
            auth0_client_secret = os.getenv("AUTH0_WEB_CLIENT_SECRET") or "",
            auth0_api_audience = os.getenv("AUTH0_API_AUDIENCE") or "",
            redis_host = os.getenv("REDIS_HOST") or "redis",
            redis_port = tonumber(os.getenv("REDIS_PORT")) or 6379,
            session_ttl = tonumber(os.getenv("CLIENT_SESSION_TTL")) or 1200,
            session_cookie_name = os.getenv("CLIENT_SESSION_COOKIE") or "CLIENT_SESSION",
            platform_api_url = os.getenv("PLATFORM_API_URL") or "http://platform:8080",
            login_api_username = os.getenv("LOGIN_API_USERNAME") or "gateway",
            login_api_password = os.getenv("LOGIN_API_PASSWORD") or "",
            client_portal_url = os.getenv("CLIENT_PORTAL_URL") or "http://client-portal:8080",
            indirect_portal_url = os.getenv("INDIRECT_PORTAL_URL") or "http://indirect-client-portal:8080",
            use_custom_login = true
        }

        -- Store config in shared dict for access by workers
        ngx.shared.sessions:set("config_auth0_domain", config.auth0_domain)
        ngx.shared.sessions:set("config_auth0_client_id", config.auth0_client_id)
        ngx.shared.sessions:set("config_auth0_client_secret", config.auth0_client_secret)
        ngx.shared.sessions:set("config_auth0_api_audience", config.auth0_api_audience)
        ngx.shared.sessions:set("config_redis_host", config.redis_host)
        ngx.shared.sessions:set("config_redis_port", config.redis_port)
        ngx.shared.sessions:set("config_session_ttl", config.session_ttl)
        ngx.shared.sessions:set("config_session_cookie_name", config.session_cookie_name)
        ngx.shared.sessions:set("config_platform_api_url", config.platform_api_url)
        ngx.shared.sessions:set("config_login_api_username", config.login_api_username)
        ngx.shared.sessions:set("config_login_api_password", config.login_api_password)
        ngx.shared.sessions:set("config_client_portal_url", config.client_portal_url)
        ngx.shared.sessions:set("config_indirect_portal_url", config.indirect_portal_url)
        ngx.shared.sessions:set("config_use_custom_login", config.use_custom_login)
        -- Keep backend_url for backwards compatibility with existing Lua scripts
        ngx.shared.sessions:set("config_backend_url", config.client_portal_url)
    }

    # Redis connection settings
    upstream redis_backend {
        server redis:6379;
        keepalive 32;
    }

    # Include server configuration
    include /etc/nginx/conf.d/*.conf;
}
